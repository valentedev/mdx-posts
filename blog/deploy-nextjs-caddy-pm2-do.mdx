---
title: "Deploy Next.js to Digital Ocean using PM2 and Caddy"
author: "Rodrigo Valente"
date: "2023-07-12"
excerpt: "How to deploy a Nextjs app to Digital Ocean using PM2 as a process manager and Caddy as a proxy server"
categories: ["Caddy", "PM2", "Nextjs", "Digital Ocean"]
---

Links to tools used in this process:

[PM2](https://pm2.keymetrics.io/)

[Caddy](https://caddyserver.com/)

[Digital Ocean](https://www.digitalocean.com/)

**Rodrigo**

> There is no one who loves pain itself, who seeks after it and wants to have it, simply because it is pain...

Create a `bash` file with the following content:

```sh
#!/bin/bash

# If there is any execution problem -e exits and -u reports it

set -eu

# Create an user (here we call it 'admin')

USERNAME=admin

# add new user and allo sudo previlegies

useradd --create-home --shell "/bin/bash" --groups sudo "${USERNAME}"

# will change password on the first login

passwd --delete "${USERNAME}"
chage --lastday 0 "${USERNAME}"

# Copy ssh keys from root to the new user

rsync --archive --chown=${USERNAME}:${USERNAME} /root/.ssh /home/${USERNAME}

export LC_ALL=en_US.UTF-8

add-apt-repository --yes universe
apt-get update

ufw allow 22
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

apt-get --yes install fail2ban

# Install Node (https://github.com/nodesource/distributions#deb)

curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - &&\
sudo apt-get install -y nodejs

# Install NPM

sudo npm install -g npm

# Install PM2

sudo npm install pm2 -g
pm2 startup

# Install Caddy (https://caddyserver.com/docs/install#debian-ubuntu-raspbian)

sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
sudo mv ~/remote/production/Caddyfile /etc/caddy/

# Upgrade all packages. Using the --force-confnew flag means that configuration files will be replaced if newer ones are available.

apt --yes -o Dpkg::Options::="--force-confnew" upgrade

echo "Script complete! Rebooting..."
reboot
```

export default ({ children }) => (
  <div className="prose prose-slate">{children}</div>
);
